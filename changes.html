<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ - –ú–û–£ –°–û–® ‚Ññ 20</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—â–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ<br>"–°—Ä–µ–¥–Ω—è—è –æ–±—â–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —à–∫–æ–ª–∞ ‚Ññ 20"<br>–∏–º–µ–Ω–∏ –ò–≤–∞–Ω–∞ –ê–Ω–¥—Ä–µ–µ–≤–∏—á–∞ –†—ã–±–∞–ª–∫–æ</h1>
    <h2>–≥–æ—Ä–æ–¥ –¢–≤–µ—Ä—å</h2>
    <div class="date" id="current-date"></div>
    <a href="index.html" class="changes-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</a>

    <!-- üîî –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
    <div class="info-message">
      <strong>–í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –û–ë–ù–û–í–õ–Ø–Æ–¢–°–Ø –î–û 15:00</strong>
    </div>
  </header>

  <div class="container">
    <h2 class="changes-title">–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ <span id="changes-date"></span></h2>

    <div class="changes-table">
      <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</div>
      <div id="error" class="error" style="display: none;"></div>

      <div class="schedule">
        <table style="display: none;">
          <thead>
            <tr>
              <th>‚Ññ</th>
              <th>–ö–ª–∞—Å—Å</th>
              <th>–£—Ä–æ–∫</th>
              <th>–ò–∑–º–µ–Ω–µ–Ω–∏—è</th>
              <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody id="changes-body">
            <!-- –î–∞–Ω–Ω—ã–µ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    <p>–ú–û–£ –°–û–® ‚Ññ 20</p>
  </footer>

  <script>
    const CONFIG = {
      SHEET_ID: '1Va5atMLtrqb9JEXE7d9eytoTUFgN-lwT0xlYOevm4S4',
      SHEET_NAME: '–ò–∑–º–µ–Ω–µ–Ω–∏—è',
      API_KEY: 'AIzaSyDGhaQXvcEv-QvHRDHP_8Q9gVEvzd6fuFI',
      AUTO_REFRESH: 300000
    };

    const elements = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      table: document.querySelector('.changes-table table'),
      tbody: document.getElementById('changes-body'),
      currentDate: document.getElementById('current-date'),
      changesDate: document.getElementById('changes-date')
    };

    document.addEventListener('DOMContentLoaded', () => {
      updateDates();
      loadSheetData();
      if (CONFIG.AUTO_REFRESH > 0) {
        setInterval(loadSheetData, CONFIG.AUTO_REFRESH);
      }
    });

    function updateDates() {
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      elements.currentDate.textContent = now.toLocaleDateString('ru-RU', options);

      const tomorrow = new Date();
      tomorrow.setDate(now.getDate() + 1);
      elements.changesDate.textContent = tomorrow.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric'
      });
    }

    async function loadSheetData() {
      try {
        showLoading();
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME}?key=${CONFIG.API_KEY}`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        const data = await response.json();
        if (!data.values || data.values.length < 2) {
          showMessage('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞');
          return;
        }
        processData(data.values);
      } catch (error) {
        showError(error);
      }
    }

    function processData(rows) {
      const [headers, ...dataRows] = rows;
      const headerMap = {};
      headers.forEach((header, index) => {
        headerMap[header.trim()] = index;
      });

      const requiredColumns = ['–ö–ª–∞—Å—Å', '–£—Ä–æ–∫', '–ò–∑–º–µ–Ω–µ–Ω–∏—è'];
      for (const column of requiredColumns) {
        if (!headerMap.hasOwnProperty(column)) {
          throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü: ${column}`);
        }
      }

      elements.tbody.innerHTML = dataRows
        .filter(row => row[headerMap['–ö–ª–∞—Å—Å']])
        .map((row, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${row[headerMap['–ö–ª–∞—Å—Å']] || ''}</td>
            <td>${row[headerMap['–£—Ä–æ–∫']] || ''}</td>
            <td>${row[headerMap['–ò–∑–º–µ–Ω–µ–Ω–∏—è']] || ''}</td>
            <td>${row[headerMap['–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ']] || ''}</td>
          </tr>
        `)
        .join('');

      showTable();
    }

    function showLoading() {
      elements.loading.style.display = 'block';
      elements.error.style.display = 'none';
      elements.table.style.display = 'none';
    }

    function showTable() {
      elements.loading.style.display = 'none';
      elements.error.style.display = 'none';
      elements.table.style.display = 'table';
    }

    function showMessage(message) {
      elements.loading.textContent = message;
      elements.loading.style.display = 'block';
      elements.error.style.display = 'none';
      elements.table.style.display = 'none';
    }

    function showError(error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      elements.loading.style.display = 'none';
      elements.table.style.display = 'none';

      let errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
      if (error.message.includes('404')) {
        errorMessage = '–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞';
      } else if (error.message.includes('403')) {
        errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ';
      }

      elements.error.innerHTML = `
        <strong>${errorMessage}</strong><br>
        ${error.message}<br><br>
        <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</small>
      `;
      elements.error.style.display = 'block';
    }
  </script>
</body>
</html>
